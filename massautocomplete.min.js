!function(){"use strict";angular.module("MassAutoComplete",[]).provider("massAutocompleteConfig",function(){var e=this;e.KEYS={TAB:9,ESC:27,ENTER:13,UP:38,DOWN:40},e.EVENTS={KEYDOWN:"keydown",RESIZE:"resize",BLUR:"blur"},e.DEBOUNCE={position:150,attach:300,suggest:200,blur:150},e.generate_random_id=function(e){return e+"_"+Math.random().toString().substring(2)},e.position_autocomplete=function(e,t){var n=t[0].getBoundingClientRect();e[0].style.top=n.height+"px",e[0].style.width=n.width+"px"},e.CLASSES={container:"ac-container",menu:"ac-menu",menu_item:"ac-menu-item",menu_item_focus:"ac-state-focus"},this.$get=function(){return e}}).directive("massAutocomplete",["massAutocompleteConfig","$timeout","$window","$document","$q",function(e,t,n,o,i){return{restrict:"A",scope:{options:"&massAutocomplete"},transclude:!0,template:'<span ng-keypress="apply_keyboard_selection($event.keyCode)" ng-transclude></span><div class="'+e.CLASSES.container+'" aria-autocomplete="list" role="listbox" ng-show="show_autocomplete"><ul class="'+e.CLASSES.menu+'"> <li ng-repeat="result in results" ng-if="$index > 0" class="'+e.CLASSES.menu_item+'" role="option" id="{{result.id}}" ng-class="$index == selected_index ? \''+e.CLASSES.menu_item_focus+'\': \'\'"><a href ng-click="apply_selection($index)" ng-bind-html="result.label"></a></li></ul></div>',link:function(e,t){t.addClass("mass-autocomplete"),e.container=angular.element(t[0].getElementsByClassName("ac-container")[0]),e.container[0].style.position="absolute"},controller:["$scope",function(a){function l(){a.show_autocomplete=!0}function c(){a.show_autocomplete=!1,_()}function s(e,n,o){var i;return function(){var a=this,l=arguments,c=function(){i=null,o||e.apply(a,l)},s=o&&!i;t.cancel(i),i=t(c,n),s&&e.apply(a,l)}}function u(t){return(!t.id||""===t.id)&&(t.id=e.generate_random_id("ac_element"),!0)}function r(){e.position_autocomplete(a.container,v)}function d(t,n){a.selected_index=0,a.waiting_for_suggestion=!0,"string"==typeof t&&t.length>0?i.when(N.suggest(t),function(o){v&&v===n&&(o&&o.length>0?(o.forEach(function(t){t.id||(t.id=e.generate_random_id("ac_item"))}),a.results=[{value:t,label:"",id:""}].concat(o),l(),N.auto_select_first&&f(1)):(a.results=[],c()))},function(e){c(),N.on_error&&N.on_error(e)})["finally"](function(){a.waiting_for_suggestion=!1}):(a.waiting_for_suggestion=!1,c(),a.$apply())}function E(e,t,n){v!==t&&(v&&h.detach(),t[0]===o[0].activeElement&&(n.on_attach&&n.on_attach(),v=t,S=e,N=n,y=e.$viewValue,A=u(t),a.container[0].setAttribute("aria-labelledby",v.id),a.results=[],a.selected_index=-1,g(),w=a.$watch(function(){return e.$modelValue},function(e){e!==$&&(r(),x(e,v))})))}function p(e){S.$modelValue!==e&&(S.$setViewValue(e),S.$render())}function _(){a.selected_index=-1,a.container[0].removeAttribute("aria-activedescendant")}function m(e){if(angular.element(a.container).get(0).scrollHeight>angular.element(a.container).height()){var t=a.results[e];if(""!==t.id){var n=angular.element("#"+t.id)[0];angular.element(a.container).scrollTop(n.offsetTop)}}}function f(e){var t=a.results[e];return v.val(t.value),a.selected_index=e,a.container[0].setAttribute("aria-activedescendant",t.id),t}function g(){angular.element(n).bind(e.EVENTS.RESIZE,C),b[e.EVENTS.BLUR]=function(){t(function(){v&&v[0]===o[0].activeElement||h.detach()},V.debounce_blur)},v.bind(e.EVENTS.BLUR,b[e.EVENTS.BLUR]),b[e.EVENTS.KEYDOWN]=function(t){if(!t.shiftKey){var n;switch(t.keyCode){case e.KEYS.ESC:a.show_autocomplete?(c(),a.$apply()):v.val(y);break;case e.KEYS.ENTER:a.show_autocomplete&&a.selected_index>0&&!a.waiting_for_suggestion&&(a.apply_selection(a.selected_index),t.stopPropagation(),t.preventDefault()),c(),a.$apply();break;case e.KEYS.TAB:if(!a.show_autocomplete)break;t.preventDefault();case e.KEYS.DOWN:a.results.length>0&&(a.show_autocomplete?(n=a.selected_index+1>a.results.length-1?0:a.selected_index+1,f(n),m(n)):(l(),f(0)),a.$apply());break;case e.KEYS.UP:a.show_autocomplete&&(t.preventDefault(),n=a.selected_index-1>=0?a.selected_index-1:a.results.length-1,f(n),m(n),a.$apply())}}},v.bind(e.EVENTS.KEYDOWN,b[e.EVENTS.KEYDOWN])}var h=this,b={};b[e.EVENTS.BLUR]=null,b[e.EVENTS.KEYDOWN]=null,b[e.EVENTS.RESIZE]=null;var v,S,N,y,w,$,A,T=a.options()||{},V={debounce_position:T.debounce_position||e.DEBOUNCE.position,debounce_attach:T.debounce_attach||e.DEBOUNCE.attach,debounce_suggest:T.debounce_suggest||e.DEBOUNCE.suggest,debounce_blur:T.debounce_blur||e.DEBOUNCE.blur};a.show_autocomplete=!1;var C=s(r,V.debounce_position),x=s(d,V.debounce_suggest);h.attach=s(E,V.debounce_attach),h.detach=function(){if(v){var t=v.val();p(t),N.on_detach&&N.on_detach(t),v.unbind(e.EVENTS.KEYDOWN,b[e.EVENTS.KEYDOWN]),v.unbind(e.EVENTS.BLUR,b[e.EVENTS.BLUR]),A&&v[0].removeAttribute("id")}c(),a.container[0].removeAttribute("aria-labelledby"),angular.element(n).unbind(e.EVENTS.RESIZE,b[e.EVENTS.RESIZE]),w&&w(),a.selected_index=a.results=void 0,S=v=y=void 0},a.apply_keyboard_selection=function(e){if(13==e){var t=f(1);$=t.value,p(t.value),c(),N.on_select&&N.on_select(t)}},a.apply_selection=function(e){if(v[0].focus(),!(!a.show_autocomplete||e>a.results.length||e<0)){var t=f(e);$=t.value,p(t.value),c(),N.on_select&&N.on_select(t)}},a.$on("$destroy",function(){h.detach(),a.container.remove()})}]}}]).directive("massAutocompleteItem",function(){return{restrict:"A",require:["^massAutocomplete","ngModel"],scope:{massAutocompleteItem:"&"},link:function(e,t,n,o){n.$set("autocomplete","off");var i=o[0],a=o[1];t.bind("focus",function(){var n=e.massAutocompleteItem();if(!n)throw new Error("Invalid options");i.attach(a,t,n)})}}})}();