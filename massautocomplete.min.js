!function(e){"use strict";e.module("MassAutoComplete",[]).provider("massAutocompleteConfig",function(){var e=this;e.KEYS={TAB:9,ESC:27,ENTER:13,UP:38,DOWN:40},e.EVENTS={KEYDOWN:"keydown",RESIZE:"resize",BLUR:"blur"},e.DEBOUNCE={position:150,attach:300,suggest:200,blur:150},e.generate_random_id=function(e){return e+"_"+Math.random().toString().substring(2)},e.position_autocomplete=function(e,t){var n=t[0].getBoundingClientRect();e[0].style.top=n.height+"px",e[0].style.left=0,e[0].style.width=n.width+"px"},this.$get=function(){return e}}).directive("massAutocomplete",["massAutocompleteConfig","$timeout","$window","$document","$q",function(t,n,o,i,a){return{restrict:"A",scope:{options:"&massAutocomplete"},transclude:!0,template:'<span ng-transclude></span><div class="ac-container" aria-autocomplete="list" role="listbox" ng-show="show_autocomplete" style="position:absolute;"><ul class="ac-menu"> <li ng-repeat="result in results" ng-if="$index > 0" class="ac-menu-item" role="option" id="{{result.id}}" ng-class="$index == selected_index ? \'ac-state-focus\': \'\'"><a href ng-click="apply_selection($index)" ng-bind-html="result.label"></a></li></ul></div>',link:function(t,n){t.container=e.element(n[0].getElementsByClassName("ac-container")[0])},controller:["$scope",function(c){function s(){c.show_autocomplete=!0}function l(){c.show_autocomplete=!1,f()}function u(e,t,o){var i;return function(){var a=this,c=arguments,s=function(){i=null,o||e.apply(a,c)},l=o&&!i;n.cancel(i),i=n(s,t),l&&e.apply(a,c)}}function r(e){return(!e.id||""===e.id)&&(e.id=t.generate_random_id("ac_element"),!0)}function d(){t.position_autocomplete(c.container,v)}function E(e,n){c.selected_index=0,c.waiting_for_suggestion=!0,"string"==typeof e&&e.length>0?a.when(S.suggest(e),function(o){v&&v===n&&(o&&o.length>0?(o.forEach(function(e){e.id||(e.id=t.generate_random_id("ac_item"))}),c.results=[{value:e,label:"",id:""}].concat(o),s(),S.auto_select_first&&m(1)):(c.results=[],l()))},function(e){l(),S.on_error&&S.on_error(e)})["finally"](function(){c.waiting_for_suggestion=!1}):(c.waiting_for_suggestion=!1,l(),c.$apply())}function p(e,t,n){v!==t&&(v&&h.detach(),t[0]===i[0].activeElement&&(n.on_attach&&n.on_attach(),v=t,N=e,S=n,w=e.$viewValue,V=r(t),c.container[0].setAttribute("aria-labelledby",v.id),c.results=[],c.selected_index=-1,g(),y=c.$watch(function(){return e.$modelValue},function(e){e!==$&&(d(),D(e,v))})))}function _(e){N.$modelValue!==e&&(N.$setViewValue(e),N.$render())}function f(){c.selected_index=-1,c.container[0].removeAttribute("aria-activedescendant")}function m(e){var t=c.results[e];return v.val(t.value),c.selected_index=e,c.container[0].setAttribute("aria-activedescendant",t.id),t}function g(){e.element(o).bind(t.EVENTS.RESIZE,A),b[t.EVENTS.BLUR]=function(){n(function(){v&&v[0]===i[0].activeElement||h.detach()},x.debounce_blur)},v.bind(t.EVENTS.BLUR,b[t.EVENTS.BLUR]),b[t.EVENTS.KEYDOWN]=function(e){if(!e.shiftKey)switch(e.keyCode){case t.KEYS.ESC:c.show_autocomplete?(l(),c.$apply()):v.val(w);break;case t.KEYS.ENTER:c.show_autocomplete&&c.selected_index>0&&!c.waiting_for_suggestion&&(c.apply_selection(c.selected_index),e.stopPropagation(),e.preventDefault()),l(),c.$apply();break;case t.KEYS.TAB:if(!c.show_autocomplete)break;e.preventDefault();case t.KEYS.DOWN:c.results.length>0&&(c.show_autocomplete?m(c.selected_index+1>c.results.length-1?0:c.selected_index+1):(s(),m(0)),c.$apply());break;case t.KEYS.UP:c.show_autocomplete&&(e.preventDefault(),m(c.selected_index-1>=0?c.selected_index-1:c.results.length-1),c.$apply())}},v.bind(t.EVENTS.KEYDOWN,b[t.EVENTS.KEYDOWN])}var h=this,b={};b[t.EVENTS.BLUR]=null,b[t.EVENTS.KEYDOWN]=null,b[t.EVENTS.RESIZE]=null;var v,N,S,w,y,$,V,T=c.options()||{},x={debounce_position:T.debounce_position||t.DEBOUNCE.position,debounce_attach:T.debounce_attach||t.DEBOUNCE.attach,debounce_suggest:T.debounce_suggest||t.DEBOUNCE.suggest,debounce_blur:T.debounce_blur||t.DEBOUNCE.blur};c.show_autocomplete=!1;var A=u(d,x.debounce_position),D=u(E,x.debounce_suggest);h.attach=u(p,x.debounce_attach),h.detach=function(){if(v){var n=v.val();_(n),S.on_detach&&S.on_detach(n),v.unbind(t.EVENTS.KEYDOWN,b[t.EVENTS.KEYDOWN]),v.unbind(t.EVENTS.BLUR,b[t.EVENTS.BLUR]),V&&v[0].removeAttribute("id")}l(),c.container[0].removeAttribute("aria-labelledby"),e.element(o).unbind(t.EVENTS.RESIZE,b[t.EVENTS.RESIZE]),y&&y(),c.selected_index=c.results=void 0,N=v=w=void 0},c.apply_selection=function(e){if(v[0].focus(),!(!c.show_autocomplete||e>c.results.length||e<0)){var t=m(e);$=t.value,_(t.value),l(),S.on_select&&S.on_select(t)}},c.$on("$destroy",function(){h.detach(),c.container.remove()})}]}}]).directive("massAutocompleteItem",function(){return{restrict:"A",require:["^massAutocomplete","ngModel"],scope:{massAutocompleteItem:"&"},link:function(e,t,n,o){n.$set("autocomplete","off");var i=o[0],a=o[1];t.bind("focus",function(){var n=e.massAutocompleteItem();if(!n)throw new Error("Invalid options");i.attach(a,t,n)})}}})}(angular);